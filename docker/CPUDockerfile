# 使用Python官方镜像，基于Debian bullseye，稳定且兼容性好
FROM python:3.10-slim-bullseye

# 使用国内阿里云镜像源，提高下载速度
RUN echo "deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list

# 安装最小化的系统依赖，添加--fix-missing处理包下载问题
RUN apt-get update --allow-insecure-repositories --allow-unauthenticated && \
    apt-get install -y --no-install-recommends --allow-unauthenticated --fix-missing \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 升级pip并使用国内镜像源，添加超时设置
RUN pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120

# 设置工作目录
WORKDIR /app

# 复制requirements.txt并安装依赖，使用--no-cache-dir减少缓存，提高安装速度
COPY requirements.txt .
RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --no-cache-dir --break-system-packages --timeout 120

# 复制本地代码
COPY . .

# 安装本地IOPaint包
RUN pip install -e . -i https://pypi.tuna.tsinghua.edu.cn/simple --no-cache-dir --break-system-packages --timeout 120

# 创建模型存放目录
RUN mkdir -p /app/models

# 暴露端口
EXPOSE 8080

# 设置启动命令
CMD ["iopaint", "start", "--model=lama", "--device=cpu", "--port=8080", "--model-dir=/app/models"]
